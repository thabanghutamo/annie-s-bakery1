{% extends "admin/base.html" %}

{% block title %}Admin - Orders{% endblock %}

{% block admin_content %}
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
      <h1 class="admin-title">Orders</h1>
      <div class="w-full sm:w-auto">
        <!-- Batch Actions -->
        <div id="batch-actions" class="hidden items-center space-x-2 mb-4 sm:mb-0">
          <select name="new_status" class="admin-form-select w-full sm:w-auto mb-2 sm:mb-0" aria-label="Update status for selected orders">
            <option value="">Update Status...</option>
            {% for status in statuses %}
            <option value="{{ status }}">{{ status|title }}</option>
            {% endfor %}
          </select>
          <select name="new_payment_status" class="text-sm border rounded px-2 py-1 w-full sm:w-auto" aria-label="Update payment status for selected orders">
            <option value="">Update Payment Status...</option>
            {% for status in payment_statuses %}
            <option value="{{ status }}">{{ status|title }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Filter Forms -->
        <form method="post" id="batch-form" class="hidden">
          <input type="hidden" name="action" value="batch_update">
        </form>
        
        <form method="get" id="filter-form" class="flex flex-col sm:flex-row items-start sm:items-center space-y-4 sm:space-y-0 sm:space-x-4">
          <div>
            <label class="text-sm text-gray-600 block">
              Order Type
              <select name="type" class="text-sm border rounded px-2 py-1 mt-1" aria-label="Filter by order type" onchange="this.form.requestSubmit();">
                <option value="all" {{ 'selected' if current_type == 'all' }}>All Orders</option>
                <option value="standard" {{ 'selected' if current_type == 'standard' }}>Standard Orders</option>
                <option value="custom" {{ 'selected' if current_type == 'custom' }}>Custom Orders</option>
              </select>
            </label>
          </div>
          <div>
            <label class="text-sm text-gray-600 block">
              Status
              <select name="status" class="text-sm border rounded px-2 py-1 mt-1" aria-label="Filter by order status" onchange="this.form.requestSubmit();">
                <option value="">All Statuses</option>
                {% for status in statuses %}
                <option value="{{ status }}" {{ 'selected' if current_status == status }}>{{ status|title }}</option>
                {% endfor %}
              </select>
            </label>
          </div>
          <div>
            <label class="text-sm text-gray-600 block">
              Payment Status
              <select name="payment" class="text-sm border rounded px-2 py-1 mt-1" aria-label="Filter by payment status" onchange="this.form.requestSubmit();">
                <option value="">All Payment Statuses</option>
                {% for status in payment_statuses %}
                <option value="{{ status }}" {{ 'selected' if current_payment == status }}>{{ status|title }}</option>
                {% endfor %}
              </select>
            </label>
          </div>
          <div>
            <label class="text-sm text-gray-600 block">
              Search
              <input type="text" name="q" value="{{ current_search }}" placeholder="Search orders..." aria-label="Search orders" class="text-sm border rounded px-2 py-1 mt-1">
            </label>
          </div>
          <div class="flex items-end space-x-2">
            <button type="submit" class="admin-button-primary">Filter</button>
            <a href="{{ url_for('admin.orders', format='csv', type=current_type, status=current_status, payment=current_payment, q=current_search) }}" 
               class="admin-button-secondary">Export CSV</a>
          </div>
        </form>
      </div>
    </div>

    {% set has_custom_orders = custom_orders|length > 0 %}
    {% set has_standard_orders = standard_orders|length > 0 %}
    {% set has_orders = has_custom_orders or has_standard_orders %}

    {# No orders message #}
    {% if not has_orders %}
    <div class="text-center py-12">
      <h3 class="text-lg font-medium text-gray-900">No Orders Found</h3>
      <p class="mt-2 text-sm text-gray-500">
        {% if current_search %}
          No orders match your search criteria. Try adjusting your filters.
        {% else %}
          There are no orders in the system yet.
        {% endif %}
      </p>
    </div>
    {% endif %}

    {# Custom Orders Section #}
    {% if current_type != 'standard' %}
    <div class="mb-8">
      <h2 class="admin-subtitle mb-4">Custom Cake Orders</h2>
      {% if not has_custom_orders %}
      <p class="text-sm text-gray-500 italic">No custom orders found.</p>
      {% else %}
      <div class="admin-card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="admin-table min-w-full table-auto">
            <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Order ID</th>
              <th scope="col" class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
              <th scope="col" class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden sm:table-cell">Details</th>
              <th scope="col" class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
              <th scope="col" class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Payment</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for order in custom_orders %}
            <tr class="hover:bg-gray-50 cursor-pointer" data-href="{{ url_for('admin.order_detail', order_id=order.id) }}" data-id="{{ order.id }}">
              <td class="px-4 sm:px-6 py-4 text-sm">{{ order.id }}</td>
              <td class="px-4 sm:px-6 py-4">
                <div class="text-sm font-medium text-gray-900">{{ order.name }}</div>
                <div class="text-sm text-gray-500">{{ order.email }}</div>
                {% if order.phone %}
                <div class="text-sm text-gray-500">{{ order.phone }}</div>
                {% endif %}
                <!-- Mobile details -->
                <div class="sm:hidden mt-2 text-sm text-gray-600">
                  <div>Size: {{ order.size }}</div>
                  <div>Flavor: {{ order.flavor }}</div>
                  {% if order.notes %}
                  <div class="truncate">Notes: {{ order.notes }}</div>
                  {% endif %}
                </div>
              </td>
              <td class="px-4 sm:px-6 py-4 hidden sm:table-cell">
                <div class="text-sm text-gray-900">
                  <div>Size: {{ order.size }}</div>
                  <div>Flavor: {{ order.flavor }}</div>
                  {% if order.notes %}
                  <div>Notes: {{ order.notes }}</div>
                  {% endif %}
                </div>
              </td>
              <td class="px-4 sm:px-6 py-4">
                <span class="inline-flex text-sm px-2 py-1 rounded {{ 'bg-yellow-100' if order.status == 'pending' else 'bg-green-100' if order.status == 'completed' else 'bg-gray-100' }}">
                  {{ order.status|title }}
                </span>
              </td>
              <td class="px-4 sm:px-6 py-4">
                <span class="inline-flex text-sm px-2 py-1 rounded {{ 'bg-red-100' if order.get('payment_status', 'pending') == 'pending' else 'bg-green-100' if order.get('payment_status', 'pending') == 'paid' else 'bg-gray-100' }}">
                  {{ order.get('payment_status', 'pending')|title }}
                </span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
    {% endif %}

    {# Regular Orders Section #}
    {% if current_type != 'custom' %}
    <div class="mb-8">
      <h2 class="admin-subtitle mb-4">Regular Orders</h2>
      {% if not has_standard_orders %}
      <p class="text-sm text-gray-500 italic">No regular orders found.</p>
      {% else %}
      <div class="admin-card overflow-hidden">
        <div class="responsive-table">
          <table class="admin-table min-w-full">
            <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Order ID</th>
              <th scope="col" class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
              <th scope="col" class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden sm:table-cell">Items</th>
              <th scope="col" class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden sm:table-cell">Total</th>
              <th scope="col" class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
              <th scope="col" class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Payment</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for order in standard_orders %}
            <tr class="hover:bg-gray-50 cursor-pointer" data-href="{{ url_for('admin.order_detail', order_id=order.id) }}" data-id="{{ order.id }}">
              <td class="px-4 sm:px-6 py-4 text-sm">{{ order.id }}</td>
              <td class="px-4 sm:px-6 py-4">
                <div class="text-sm font-medium text-gray-900">{{ order.customer_name }}</div>
                <div class="text-sm text-gray-500">{{ order.customer_email }}</div>
                {% if order.customer_phone %}
                <div class="text-sm text-gray-500">{{ order.customer_phone }}</div>
                {% endif %}
                <!-- Mobile order details -->
                <div class="sm:hidden mt-2 text-sm text-gray-600">
                  {% if order['items'] %}
                    {% for item in order['items'] %}
                    <div>{{ item['quantity'] }}x {{ item['title'] }}</div>
                    {% endfor %}
                  {% endif %}
                  <div class="mt-1 font-medium">Total: R{{ "%.2f"|format(order['total']) }}</div>
                </div>
              </td>
              <td class="px-4 sm:px-6 py-4 hidden sm:table-cell">
                <div class="text-sm text-gray-900">
                  {% if order['items'] %}
                    {% for item in order['items'] %}
                    <div>{{ item['quantity'] }}x {{ item['title'] }} (R{{ "%.2f"|format(item['price']) }})</div>
                    {% endfor %}
                  {% endif %}
                </div>
              </td>
              <td class="px-4 sm:px-6 py-4 hidden sm:table-cell text-sm text-gray-900">R{{ "%.2f"|format(order['total']) }}</td>
              <td class="px-4 sm:px-6 py-4">
                <span class="inline-flex text-sm px-2 py-1 rounded {{ 'bg-yellow-100' if order.status == 'pending' else 'bg-green-100' if order.status == 'completed' else 'bg-gray-100' }}">
                  {{ order.status|title }}
                </span>
              </td>
              <td class="px-4 sm:px-6 py-4">
                <span class="inline-flex text-sm px-2 py-1 rounded {{ 'bg-red-100' if order.payment_status == 'pending' else 'bg-green-100' if order.payment_status == 'paid' else 'bg-gray-100' }}">
                  {{ order.payment_status|title }}
                </span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
    {% endif %}
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Make table rows clickable and handle batch selection
    document.querySelectorAll('tr[data-href]').forEach(row => {
      const checkbox = row.querySelector('input[type="checkbox"]');
      
      // Add checkbox at start of row
      if (!checkbox) {
        const firstCell = row.querySelector('td');
        if (firstCell) {
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.name = 'order_ids[]';
          cb.value = row.dataset.id || '';
          cb.className = 'mr-2';
          firstCell.insertBefore(cb, firstCell.firstChild);
        }
      }
      
      row.addEventListener('click', (e) => {
        const checkbox = e.target.closest('tr').querySelector('input[type="checkbox"]');
        // If clicking the checkbox, don't navigate
        if (e.target === checkbox) {
          updateBatchActions();
          return;
        }
        // If clicking anywhere else, navigate
        window.location.href = row.dataset.href;
      });
    });
    
    // Handle filter form submission
    const filterForm = document.querySelector('#filter-form');
    if (filterForm) {
      filterForm.addEventListener('submit', (e) => {
        // Remove empty filter values before submitting
        const formData = new FormData(filterForm);
        for (const [key, value] of formData.entries()) {
          if (!value) {
            const input = filterForm.querySelector(`[name="${key}"]`);
            if (input) {
              input.disabled = true;
            }
          }
        }
      });
    }

    // Handle batch actions
    function updateBatchActions() {
      const checkboxes = document.querySelectorAll('input[name="order_ids[]"]:checked');
      const batchForm = document.getElementById('batch-form');
      const batchActions = document.getElementById('batch-actions');
      
      if (checkboxes.length > 0) {
        batchActions.style.display = 'flex';
        // Update hidden form
        batchForm.innerHTML = '<input type="hidden" name="action" value="batch_update">';
        checkboxes.forEach(cb => {
          batchForm.insertAdjacentHTML('beforeend', 
            `<input type="hidden" name="order_ids[]" value="${cb.value}">`
          );
        });
      } else {
        batchActions.style.display = 'none';
      }
    }

    // Initialize batch actions
    updateBatchActions();

    // Handle batch action submission
    document.querySelectorAll('[name="new_status"], [name="new_payment_status"]')
      .forEach(select => {
        select.addEventListener('change', (e) => {
          const batchForm = document.getElementById('batch-form');
          const hiddenInput = document.createElement('input');
          hiddenInput.type = 'hidden';
          hiddenInput.name = e.target.name;
          hiddenInput.value = e.target.value;
          batchForm.appendChild(hiddenInput);
          batchForm.submit();
        });
      });
  });
</script>
{% endblock %}