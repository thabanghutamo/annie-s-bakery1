<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - Orders</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htmx.org@1.9.9"></script>
</head>
<body class="bg-gray-50">
  <!-- Navigation -->
  <nav class="bg-white shadow mb-6">
    <div class="max-w-6xl mx-auto px-4">
      <div class="flex justify-between h-16">
        <div class="flex">
          <a href="/admin" class="flex items-center font-bold text-lg">
            Annie's Admin
          </a>
          <div class="ml-8 flex items-center space-x-4">
            <a href="/admin/products" class="text-gray-700 hover:text-blue-600">Products</a>
            <a href="/admin/blog" class="text-gray-700 hover:text-blue-600">Blog</a>
            <a href="/admin/orders" class="text-gray-700 hover:text-blue-600 font-semibold">Orders</a>
            <a href="/admin/settings" class="text-gray-700 hover:text-blue-600">Settings</a>
          </div>
        </div>
        <div class="flex items-center">
          <a href="/admin/orders/new" class="text-sm bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            New Custom Order
          </a>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto px-4">
    <!-- Header and filters section -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">Orders</h1>
      <div class="space-x-2">
        <!-- Batch Actions -->
        <div id="batch-actions" class="hidden items-center space-x-2">
          <select name="new_status" class="text-sm border rounded px-2 py-1" aria-label="Update status for selected orders">
            <option value="">Update Status...</option>
            {% for status in statuses %}
            <option value="{{ status }}">{{ status|title }}</option>
            {% endfor %}
          </select>
          <select name="new_payment_status" class="text-sm border rounded px-2 py-1" aria-label="Update payment status for selected orders">
            <option value="">Update Payment Status...</option>
            {% for status in payment_statuses %}
            <option value="{{ status }}">{{ status|title }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Filter Forms -->
        <form method="post" id="batch-form" class="hidden">
          <input type="hidden" name="action" value="batch_update">
        </form>
        
        <form method="get" id="filter-form" class="flex items-center space-x-4">
          <!-- Filter controls -->
          <div>
            <label class="text-sm text-gray-600 block">
              Order Type
              <select name="type" class="text-sm border rounded px-2 py-1 mt-1" aria-label="Filter by order type" onchange="this.form.requestSubmit();">
                <option value="all" {{ 'selected' if current_type == 'all' }}>All Orders</option>
                <option value="standard" {{ 'selected' if current_type == 'standard' }}>Standard Orders</option>
                <option value="custom" {{ 'selected' if current_type == 'custom' }}>Custom Orders</option>
              </select>
            </label>
          </div>
          <div>
            <label class="text-sm text-gray-600 block">
              Status
              <select name="status" class="text-sm border rounded px-2 py-1 mt-1" aria-label="Filter by order status" onchange="this.form.requestSubmit();">
                <option value="">All Statuses</option>
                {% for status in statuses %}
                <option value="{{ status }}" {{ 'selected' if current_status == status }}>
                  {{ status|title }}
                </option>
                {% endfor %}
              </select>
            </label>
          </div>
          <div>
            <label class="text-sm text-gray-600 block">
              Payment Status
              <select name="payment" class="text-sm border rounded px-2 py-1 mt-1" aria-label="Filter by payment status" onchange="this.form.requestSubmit();">
                <option value="">All Payment Statuses</option>
                {% for status in payment_statuses %}
                <option value="{{ status }}" {{ 'selected' if current_payment == status }}>
                  {{ status|title }}
                </option>
                {% endfor %}
              </select>
            </label>
          </div>
          <div>
            <label class="text-sm text-gray-600 block">
              Search
              <input type="text" name="q" value="{{ current_search }}" placeholder="Search orders..." aria-label="Search orders" class="text-sm border rounded px-2 py-1 mt-1">
            </label>
          </div>
          <div class="flex items-end space-x-2">
            <button type="submit" class="bg-blue-500 text-white px-3 py-1 rounded text-sm">Filter</button>
            <a href="{{ url_for('admin.orders', format='csv', type=current_type, status=current_status, payment=current_payment, q=current_search) }}" class="bg-green-500 text-white px-3 py-1 rounded text-sm">Export CSV</a>
          </div>
        </form>
      </div>
    </div>

    {% set has_custom_orders = custom_orders|length > 0 %}
    {% set has_standard_orders = standard_orders|length > 0 %}
    {% set has_orders = has_custom_orders or has_standard_orders %}

    {# Start: No orders message #}
    {% if not has_orders %}
    <div class="text-center py-12">
      <h3 class="text-lg font-medium text-gray-900">No Orders Found</h3>
      <p class="mt-2 text-sm text-gray-500">
        {% if current_search %}
          No orders match your search criteria. Try adjusting your filters.
        {% else %}
          There are no orders in the system yet.
        {% endif %}
      </p>
    </div>
    {% endif %}
    {# End: No orders message #}

    {# Start: Custom Orders Section #}
    {% if current_type != 'standard' %}
    <div class="mb-8">
      <h2 class="text-xl font-semibold mb-4">Custom Cake Orders</h2>
      {% if not has_custom_orders %}
      <p class="text-sm text-gray-500 italic">No custom orders found.</p>
      {% else %}
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Order ID</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Details</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Payment</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for order in custom_orders %}
            <tr class="hover:bg-gray-50 cursor-pointer" 
                data-href="{{ url_for('admin.order_detail', order_id=order.id) }}"
                data-id="{{ order.id }}">
              <td class="px-6 py-4 whitespace-nowrap text-sm">{{ order.id }}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">{{ order.customer_name }}</div>
                <div class="text-sm text-gray-500">{{ order.customer_email }}</div>
                {% if order.customer_phone %}
                <div class="text-sm text-gray-500">{{ order.customer_phone }}</div>
                {% endif %}
              </td>
              <td class="px-6 py-4">
                <div class="text-sm text-gray-900">
                  <div>Size: {{ order.details.size }}</div>
                  <div>Flavor: {{ order.details.flavor }}</div>
                  {% if order.details.message %}
                  <div>Message: {{ order.details.message }}</div>
                  {% endif %}
                  <div>Pickup: {{ order.details.pickup_date }}</div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="text-sm px-2 py-1 rounded {{ 'bg-yellow-100' if order.status == 'pending' else 'bg-green-100' if order.status == 'completed' else 'bg-gray-100' }}">
                  {{ order.status|title }}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="text-sm px-2 py-1 rounded {{ 'bg-red-100' if order.payment_status == 'pending' else 'bg-green-100' if order.payment_status == 'paid' else 'bg-gray-100' }}">
                  {{ order.payment_status|title }}
                </span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
    {% endif %}
    {# End: Custom Orders Section #}

    {# Start: Regular Orders Section #}
    {% if current_type != 'custom' %}
    <div class="mb-8">
      <h2 class="text-xl font-semibold mb-4">Regular Orders</h2>
      {% if not has_standard_orders %}
      <p class="text-sm text-gray-500 italic">No regular orders found.</p>
      {% else %}
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Order ID</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Items</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Payment</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for order in standard_orders %}
            <tr class="hover:bg-gray-50 cursor-pointer"
                data-href="{{ url_for('admin.order_detail', order_id=order.id) }}"
                data-id="{{ order.id }}">
              <td class="px-6 py-4 whitespace-nowrap text-sm">{{ order.id }}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">{{ order.customer_name }}</div>
                <div class="text-sm text-gray-500">{{ order.customer_email }}</div>
                {% if order.customer_phone %}
                <div class="text-sm text-gray-500">{{ order.customer_phone }}</div>
                {% endif %}
              </td>
              <td class="px-6 py-4">
                <div class="text-sm text-gray-900">
                  {% for item in order.items %}
                  <div>{{ item.quantity }}x {{ item.title }} (R{{ "%.2f"|format(item.price) }})</div>
                  {% endfor %}
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">R{{ "%.2f"|format(order.total) }}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="text-sm px-2 py-1 rounded {{ 'bg-yellow-100' if order.status == 'pending' else 'bg-green-100' if order.status == 'completed' else 'bg-gray-100' }}">
                  {{ order.status|title }}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="text-sm px-2 py-1 rounded {{ 'bg-red-100' if order.payment_status == 'pending' else 'bg-green-100' if order.payment_status == 'paid' else 'bg-gray-100' }}">
                  {{ order.payment_status|title }}
                </span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
    {% endif %}
    {# End: Regular Orders Section #}

  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Make table rows clickable and handle batch selection
      document.querySelectorAll('tr[data-href]').forEach(row => {
        const checkbox = row.querySelector('input[type="checkbox"]');
        
        // Add checkbox at start of row
        if (!checkbox) {
          const firstCell = row.querySelector('td');
          if (firstCell) {
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.name = 'order_ids[]';
            cb.value = row.dataset.id || '';
            cb.className = 'mr-2';
            firstCell.insertBefore(cb, firstCell.firstChild);
          }
        }
        
        row.addEventListener('click', (e) => {
          const checkbox = e.target.closest('tr').querySelector('input[type="checkbox"]');
          // If clicking the checkbox, don't navigate
          if (e.target === checkbox) {
            updateBatchActions();
            return;
          }
          // If clicking anywhere else, navigate
          window.location.href = row.dataset.href;
        });
      });
      
      // Handle filter form submission
      const filterForm = document.querySelector('#filter-form');
      if (filterForm) {
        filterForm.addEventListener('submit', (e) => {
          // Remove empty filter values before submitting
          const formData = new FormData(filterForm);
          for (const [key, value] of formData.entries()) {
            if (!value) {
              const input = filterForm.querySelector(`[name="${key}"]`);
              if (input) {
                input.disabled = true;
              }
            }
          }
        });
      }

      // Handle batch actions
      function updateBatchActions() {
        const checkboxes = document.querySelectorAll('input[name="order_ids[]"]:checked');
        const batchForm = document.getElementById('batch-form');
        const batchActions = document.getElementById('batch-actions');
        
        if (checkboxes.length > 0) {
          batchActions.style.display = 'flex';
          // Update hidden form
          batchForm.innerHTML = '<input type="hidden" name="action" value="batch_update">';
          checkboxes.forEach(cb => {
            batchForm.insertAdjacentHTML('beforeend', 
              `<input type="hidden" name="order_ids[]" value="${cb.value}">`
            );
          });
        } else {
          batchActions.style.display = 'none';
        }
      }

      // Initialize batch actions
      updateBatchActions();

      // Handle batch action submission
      document.querySelectorAll('[name="new_status"], [name="new_payment_status"]')
        .forEach(select => {
          select.addEventListener('change', (e) => {
            const batchForm = document.getElementById('batch-form');
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = e.target.name;
            hiddenInput.value = e.target.value;
            batchForm.appendChild(hiddenInput);
            batchForm.submit();
          });
        });
    });
  </script>
</body>
</html>